# Safe network tuning for Plex Proxy Pi
# These values favor stable streaming over absolute throughput.

# ============================================================================
# TCP Buffer Tuning
# ============================================================================
# Increase TCP buffers for high-latency tunnels.
net.core.rmem_max = 2621440
net.core.wmem_max = 2621440
net.ipv4.tcp_rmem = 4096 87380 2097152
net.ipv4.tcp_wmem = 4096 65536 2097152

# Moderately sized backlog and connections.
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_max_syn_backlog = 2048

# ============================================================================
# Congestion Control
# ============================================================================
# Use BBR for smoother congestion control on variable Wi-Fi/WG paths.
net.ipv4.tcp_congestion_control = bbr

# ============================================================================
# Connection Tracking (Conntrack) Tuning
# ============================================================================
# These settings help prevent the WireGuard tunnel from "going cold" due to
# conntrack entries expiring. This is especially important when NAT is involved.
#
# Default UDP timeout is 30s for new connections, 120s for established streams.
# We increase these to prevent premature expiration of WireGuard UDP sessions.

# UDP timeout for connections that haven't seen reply traffic yet (default: 30)
net.netfilter.nf_conntrack_udp_timeout = 120

# UDP timeout for "established" streams (bidirectional traffic seen) (default: 120)
net.netfilter.nf_conntrack_udp_timeout_stream = 300

# Generic timeout for connections (default: 600)
net.netfilter.nf_conntrack_generic_timeout = 600

# ============================================================================
# TCP Keepalive Settings
# ============================================================================
# These help detect dead connections faster and keep NAT mappings alive.

# Time before sending first keepalive probe (default: 7200 = 2 hours)
net.ipv4.tcp_keepalive_time = 60

# Interval between keepalive probes (default: 75)
net.ipv4.tcp_keepalive_intvl = 30

# Number of probes before considering connection dead (default: 9)
net.ipv4.tcp_keepalive_probes = 5

# ============================================================================
# Additional Network Stability Settings
# ============================================================================
# Enable TCP timestamps for better RTT estimation
net.ipv4.tcp_timestamps = 1

# Enable selective acknowledgments for better loss recovery
net.ipv4.tcp_sack = 1

# Disable TCP slow start after idle (helps with bursty streaming traffic)
net.ipv4.tcp_slow_start_after_idle = 0
